<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bmw.mapper.OrderMapper">
  <resultMap id="BaseResultMap" type="com.bmw.entity.Order">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 16 22:01:36 CST 2019.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="orderId" jdbcType="VARCHAR" property="orderid" />
    <result column="carType" jdbcType="VARCHAR" property="cartype" />
    <result column="modelCode" jdbcType="VARCHAR" property="modelcode" />
    <result column="modelDesc" jdbcType="VARCHAR" property="modeldesc" />
    <result column="modelSeries" jdbcType="VARCHAR" property="modelseries" />
    <result column="colorCode" jdbcType="VARCHAR" property="colorcode" />
    <result column="upholsteryCode" jdbcType="VARCHAR" property="upholsterycode" />
    <result column="apw" jdbcType="VARCHAR" property="apw" />
    <result column="yearType" jdbcType="VARCHAR" property="yeartype" />
    <result column="configCode" jdbcType="VARCHAR" property="configcode" />
    <result column="price" jdbcType="BIGINT" property="price" />
    <result column="addPrice" jdbcType="VARCHAR" property="addprice" />
    <result column="addCode" jdbcType="VARCHAR" property="addcode" />
    <result column="dealerId" jdbcType="VARCHAR" property="dealerid" />
    <result column="dealerStatus" jdbcType="VARCHAR" property="dealerstatus" />
    <result column="colorFav" jdbcType="BIGINT" property="colorfav" />
    <result column="upholsteryFav" jdbcType="BIGINT" property="upholsteryfav" />
    <result column="modelFav" jdbcType="BIGINT" property="modelfav" />
    <result column="materialsId" jdbcType="VARCHAR" property="materialsid" />
  </resultMap>
  
  <resultMap id="OrderDTO" type="com.bmw.dto.OrderDTO">
    <result column="dealerId" jdbcType="VARCHAR" property="dealerId" />
    <result column="apw" jdbcType="VARCHAR" property="apw" />
    <result column="orderId" jdbcType="VARCHAR" property="orderId" />
    <result column="brand" jdbcType="VARCHAR" property="brand" />
    <result column="modelCode" jdbcType="VARCHAR" property="modelCode" />
    <result column="upholsteryCode" jdbcType="VARCHAR" property="upholsteryCode" />
    <result column="upholsteryDesc" jdbcType="VARCHAR" property="upholsteryDesc" />
    <result column="addCode" jdbcType="VARCHAR" property="addCodes" />
    <result column="addPrice" jdbcType="VARCHAR" property="addPrice" />
    <result column="price" jdbcType="BIGINT" property="price" />
    <result column="dealerStatus" jdbcType="BIGINT" property="dealerStatus" />
    <result column="materialsId" jdbcType="VARCHAR" property="materialsId" />
    
    <result column="configCode" jdbcType="VARCHAR" property="configCode" />
    <result column="upholsteryCodeT" jdbcType="VARCHAR" property="upholsteryCodeT" />
    <result column="addCodeT" jdbcType="VARCHAR" property="addCodesT" />
    <result column="colorCode" jdbcType="VARCHAR" property="colorCode" />
    <result column="colorDesc" jdbcType="VARCHAR" property="colorDesc" />
    <result column="colorCodeT" jdbcType="VARCHAR" property="colorCodeT" />
    <result column="configCodeT" jdbcType="VARCHAR" property="configCodeT" />
  </resultMap>
  
  <resultMap id="OrderGroup" type="com.bmw.dto.OrderGroup">
    <result column="amount" jdbcType="BIGINT" property="amount" />
    <result column="totalPrice" jdbcType="FLOAT" property="totalPrice" />
    <result column="remain" jdbcType="BIGINT" property="remain" />
    <result column="totalRemain" jdbcType="BIGINT" property="totalRemain" />
    
    <result column="addCode" jdbcType="VARCHAR" property="addCodes" />
    <result column="colorCode" jdbcType="VARCHAR" property="colorCode" />
    <result column="colorDesc" jdbcType="VARCHAR" property="colorDesc" />
    <result column="upholsteryCode" jdbcType="VARCHAR" property="upholsteryCode" />
    <result column="upholsteryDesc" jdbcType="VARCHAR" property="upholsteryDesc" />
    <result column="configCode" jdbcType="VARCHAR" property="configCode" />
    <result column="configDesc" jdbcType="VARCHAR" property="configDesc" />
  </resultMap>
  
  <resultMap id="OrderFlow" type="com.bmw.dto.OrderFlow">
    <result column="dealerName" jdbcType="VARCHAR" property="target" />
    <result column="description" jdbcType="VARCHAR" property="source" />
    <result column="amount" jdbcType="BIGINT" property="value" />
  </resultMap>
  
  <sql id="Base_Get_Orders">
		SELECT o."dealerId", o."orderId",
		       'BMW' as "brand", mt."modelCode", 
			   mt."apw", 
			   mt."upholsteryCode", mt."upholsteryDesc",
			   o."upholsteryCode" as "upholsteryCodeT",
			   mt."addCode", mt."addPrice",
			   o."addCode" as "addCodeT",
			   mt."price", o."dealerStatus", mt."materialsId",
			   mt."colorCode", mt."colorDesc",
			   o."colorCode" as "colorCodeT",
			   mt."configCode",
			   o."configCode" as "configCodeT"
			FROM sales.materials mt, sales.order o where mt."materialsId" = o."materialsId" 
  </sql>
  
  <select id="getUnconfirmedOrderList" parameterType="java.util.Map" resultMap="OrderDTO">
			<include refid="Base_Get_Orders" />
			and o."dealerId" =  #{dealerId} 
			and o."dealerStatus" = '1'
  </select>
  
  <select id="getUnpaidOrderGroups" parameterType="java.util.Map" resultMap="OrderGroup">
		select 
		sum(mt.price+cast(mt."addPrice" as double precision)) as "totalPrice",
		count(*) as amount, 
		(select count(*) from sales.materials mat, sales.order od 
		 	where mat."materialsId" = od."materialsId" 
		 	and od."dealerStatus" != '3') as "totalRemain",
		(select count(*) from sales.materials mat, sales.order od 
		 	where mat."materialsId" = od."materialsId" 
		 	and od."dealerStatus" != '3'
			and mat."colorCode" = o."colorCode"
			and mat."upholsteryCode" = o."upholsteryCode"
			and mat."configCode" = o."configCode"
			and mat."addCode" = o."addCode") as remain,
		o."colorCode", o."upholsteryCode",o."configCode", o."addCode",
		co."colorDescription" as "colorDesc",
		up."upholsteryDescription" as "upholsteryDesc", 
		va."variantDescription" as "configDesc"
		from sales.order o,sales.materials mt, sales.color co, sales.upholstery up, sales.variant va
		where o."dealerId"= #{dealerId} and o."materialsId" = mt."materialsId"
		and o."colorCode" = co."colorCode" 
		and o."dealerStatus" = '2'
		and o."upholsteryCode" = up."upholsteryCode" 
		and o."configCode" = va."variantCode"
		group by o."colorCode", o."upholsteryCode",o."configCode", o."addCode", 
		co."colorDescription", up."upholsteryDescription", va."variantDescription"
  </select>
  
  <select id="getRemains" parameterType="java.util.Map" resultMap="OrderGroup">
		select count(*) as amount,
		(select count(*) from sales.materials mat, sales.order od 
		 	where mat."materialsId" = od."materialsId" 
		 	and od."dealerStatus" != '3') as "totalRemain",
		(select count(*) from sales.materials mat, sales.order od 
		 	where mat."materialsId" = od."materialsId" 
		 	and od."dealerStatus" != '3'
			and mat."colorCode" = o."colorCode"
			and mat."upholsteryCode" = o."upholsteryCode"
			and mat."configCode" = o."configCode"
			and mat."addCode" = o."addCode") as remain,
		o."colorCode", o."upholsteryCode",o."configCode", o."addCode"
		from sales.order o,sales.materials mt
		where o."dealerId"= #{dealerId} and o."materialsId" = mt."materialsId"
		and o."dealerStatus" = '2'
		group by o."colorCode", o."upholsteryCode",o."configCode", o."addCode"
  </select>
  
  <select id="getUnpaidOrdersByGroup" parameterType="java.util.Map" resultMap="OrderDTO">
			<include refid="Base_Get_Orders" />
			and o."dealerId" =  #{dealerId} 
			and o."dealerStatus" = '2'
			and o."colorCode" = #{colorCode}
			and o."upholsteryCode" = #{upholsteryCode}
			and o."configCode" = #{configCode}
			and o."addCode" = #{addCode}
  </select>
  
  <select id="getPaidOrderList" parameterType="java.util.Map" resultMap="OrderDTO">
			<include refid="Base_Get_Orders" />
			and o."dealerId" =  #{dealerId} 
			and o."dealerStatus" = '3'
  </select>
  
  <select id="getOrderFlows" parameterType="java.lang.String" resultMap="OrderFlow">
	select count(*) amount,d."dealerName",
	va."variantDescription"||' '|| co."colorDescription"||' '||up."upholsteryDescription"||' '||o."yearType"||' '||o."addCode" as description
	from sales.order o, sales.upholstery up, sales.variant va, sales.color co, sales.dealer d
	where o."dealerStatus" != '0'
	<if test="value != null">
		and o."matchStatus" = #{value}
	</if>
	and o."colorCode" = co."colorCode" 
	and o."upholsteryCode" = up."upholsteryCode" 
	and o."configCode" = va."variantCode"
	and o."dealerId" = d."dealerId"
	group by o."colorCode", o."upholsteryCode",o."configCode", o."addCode",d."dealerId", d."dealerName",o."yearType",
	co."colorDescription", up."upholsteryDescription", va."variantDescription"
  </select>
  
  <update id="updateOrderStatus" parameterType="java.util.Map">
	update sales.order set "dealerStatus" = #{dealerStatus} 
	where "orderId" in <foreach item="orderId" index="index" collection="orderIdList" open="(" separator="," close=")">
				#{orderId}
	</foreach>
  </update>
</mapper>